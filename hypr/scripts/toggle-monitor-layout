#!/usr/bin/env bash
set -euo pipefail

PRIMARY_OUTPUT="${HYPR_MONITOR_PRIMARY:-}"
EXTEND_OUTPUT="${HYPR_MONITOR_EXTERNAL:-}"
MONITOR_MODE="preferred"
STATE_FILE="/tmp/hypr-external-workspaces"

monitor_json=""
active_monitor_json=""

resolve_outputs() {
  monitor_json=$(hyprctl -j monitors all)
  active_monitor_json=$(hyprctl -j monitors)

  if [[ -z "$PRIMARY_OUTPUT" ]]; then
    PRIMARY_OUTPUT=$(jq -r '.[] | select(.name | test("^(eDP|LVDS|DSI)")) | .name' <<<"$active_monitor_json" | head -n 1)
  fi

  if [[ -z "$PRIMARY_OUTPUT" ]]; then
    PRIMARY_OUTPUT=$(jq -r '.[] | select(.focused == true) | .name' <<<"$active_monitor_json" | head -n 1)
  fi

  if [[ -z "$PRIMARY_OUTPUT" ]]; then
    PRIMARY_OUTPUT=$(jq -r '.[0].name // empty' <<<"$active_monitor_json")
  fi

  if [[ -z "$EXTEND_OUTPUT" ]]; then
    EXTEND_OUTPUT=$(jq -r --arg primary "$PRIMARY_OUTPUT" '.[] | select(.name != $primary) | .name' <<<"$active_monitor_json" | head -n 1)
  fi

  if [[ -z "$EXTEND_OUTPUT" || "$EXTEND_OUTPUT" == "null" ]]; then
    EXTEND_OUTPUT=$(jq -r --arg primary "$PRIMARY_OUTPUT" '.[] | select(.name != $primary) | .name' <<<"$monitor_json" | head -n 1)
  fi
}

is_mirrored() {
  jq -e --arg output "$EXTEND_OUTPUT" '.[] | select(.name == $output) | (.mirrorOf != "" and .mirrorOf != "none" and .mirrorOf != null)' <<<"$monitor_json" >/dev/null 2>&1
}

wait_for_extend_ready() {
  local i=0
  while (( i < 25 )); do
    local state_all_json
    local state_active_json
    state_all_json=$(hyprctl -j monitors all 2>/dev/null || true)
    state_active_json=$(hyprctl -j monitors 2>/dev/null || true)

    if jq -e --arg output "$EXTEND_OUTPUT" '.[] | select(.name == $output)' <<<"$state_active_json" >/dev/null 2>&1 \
      && jq -e --arg output "$EXTEND_OUTPUT" '.[] | select(.name == $output) | (.mirrorOf == "" or .mirrorOf == "none" or .mirrorOf == null)' <<<"$state_all_json" >/dev/null 2>&1; then
      return 0
    fi

    sleep 0.1
    ((i += 1))
  done
}

save_external_workspaces() {
  hyprctl -j workspaces \
    | jq -r --arg output "$EXTEND_OUTPUT" '.[] | select(.monitor == $output and (.id // 0) > 0) | .name' \
    >"$STATE_FILE" 2>/dev/null || true
}

restore_external_workspaces() {
  [[ -f "$STATE_FILE" ]] || return 0

while IFS= read -r workspace; do
    [[ -n "$workspace" ]] || continue
    hyprctl dispatch moveworkspacetomonitor "$workspace" "$EXTEND_OUTPUT" >/dev/null 2>&1 || true
  done <"$STATE_FILE"
}

refresh_waybar() {
  local extra_delay="${1:-0}"
  sleep "$extra_delay"

  if pgrep -x waybar >/dev/null 2>&1; then
    pkill -SIGUSR2 -x waybar >/dev/null 2>&1 || true
    return
  fi

  waybar -c ~/.config/waybar/config.jsonc -s ~/.config/waybar/style.css >/dev/null 2>&1 &
}

apply_extend() {
  hyprctl --batch "keyword monitor $PRIMARY_OUTPUT,$MONITOR_MODE,auto,1; keyword monitor $EXTEND_OUTPUT,$MONITOR_MODE,auto-right,1"
  wait_for_extend_ready || true
  restore_external_workspaces
  refresh_waybar 0.6
  hyprctl notify 1 1500 "rgb(89b4fa)" "Display mode: Extend ($PRIMARY_OUTPUT + $EXTEND_OUTPUT)"
}

apply_mirror() {
  save_external_workspaces
  hyprctl --batch "keyword monitor $PRIMARY_OUTPUT,$MONITOR_MODE,auto,1; keyword monitor $EXTEND_OUTPUT,$MONITOR_MODE,auto,1,mirror,$PRIMARY_OUTPUT"
  refresh_waybar 0.2
  hyprctl notify 1 1500 "rgb(89b4fa)" "Display mode: Mirror ($EXTEND_OUTPUT -> $PRIMARY_OUTPUT)"
}

resolve_outputs

if [[ -z "$EXTEND_OUTPUT" || "$EXTEND_OUTPUT" == "null" ]]; then
  hyprctl notify 3 2000 "rgb(f38ba8)" "Display mode: no external monitor found"
  exit 1
fi

if is_mirrored; then
  apply_extend
else
  apply_mirror
fi
