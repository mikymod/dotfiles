#!/usr/bin/env bash
set -euo pipefail

PRIMARY_OUTPUT="${HYPR_MONITOR_PRIMARY:-}"
EXTEND_OUTPUT="${HYPR_MONITOR_EXTERNAL:-}"

monitor_json=$(hyprctl -j monitors all)

if [[ -z "$PRIMARY_OUTPUT" ]]; then
  PRIMARY_OUTPUT=$(jq -r '.[] | select(.name | test("^(eDP|LVDS|DSI)")) | .name' <<<"$monitor_json" | head -n 1)
fi

if [[ -z "$PRIMARY_OUTPUT" ]]; then
  PRIMARY_OUTPUT=$(jq -r '.[] | select(.focused == true) | .name' <<<"$monitor_json" | head -n 1)
fi

if [[ -z "$PRIMARY_OUTPUT" ]]; then
  PRIMARY_OUTPUT=$(jq -r '.[0].name' <<<"$monitor_json")
fi

if [[ -z "$EXTEND_OUTPUT" ]]; then
  EXTEND_OUTPUT=$(jq -r --arg primary "$PRIMARY_OUTPUT" '.[] | select(.name != $primary) | .name' <<<"$monitor_json" | head -n 1)
fi

if [[ -z "$EXTEND_OUTPUT" || "$EXTEND_OUTPUT" == "null" ]]; then
  echo "{\"alt\":\"single\",\"tooltip\":\"Display mode: Single ($PRIMARY_OUTPUT)\"}"
  exit 0
fi

if jq -e --arg output "$EXTEND_OUTPUT" '.[] | select(.name == $output) | (.mirrorOf != "" and .mirrorOf != "none" and .mirrorOf != null)' >/dev/null <<<"$monitor_json"; then
  echo "{\"alt\":\"mirror\",\"tooltip\":\"Display mode: Mirror ($EXTEND_OUTPUT -> $PRIMARY_OUTPUT)\"}"
else
  echo "{\"alt\":\"extend\",\"tooltip\":\"Display mode: Extend ($PRIMARY_OUTPUT + $EXTEND_OUTPUT)\"}"
fi
